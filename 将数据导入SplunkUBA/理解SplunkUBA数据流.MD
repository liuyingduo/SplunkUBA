# 理解Splunk UBA中的数据流

Splunk UBA的整个数据流向如下图所示：
![图示](https://docs.splunk.com/images/thumb/4/4f/UBA_Data_Flow_v5.png/1050px-UBA_Data_Flow_v5.png)

|步骤|过程|描述|
|----|----|----|
|1|来自splunk平台的原始数据和已解析的数据|splunk UBA可以提取解析符合[CIM(Common Information Model)](https://docs.splunk.com/Documentation/Splunk/8.1.1/Knowledge/UnderstandandusetheCommonInformationModel)的数据或原始数据。你必须选择合适的连接器(connector)类型。使用**Splunk Direct**连接器在splunk上面解析数据之后再进入Splunk UBA。使用**Splunk Raw Events**连接器使用Splunk UBA本地的解析器来解析数据。 |
|2|账户规范化和身份解析|Splunk UBA分析来自Splunk的数据，并将数据中的字段映射到UBA中的特定字段，正确映射的数据字段可以使Splunk UBA能够执行如下操作：1、规范化设备和域名，并将其HR数据中标识的所有帐户与单个人工账户相关联。2、执行身份解析以查找IP地址，主机名和用户之间的实时关联，并随着时间的推移保持这些关联|
|3|特定于每种数据类型的视图|Splunk UBA将数据进行一定程度上的抽象，以使你可以看到重要的，相关的数据。例如，防火墙日志由于不同厂商来源具有多种日志格式。Splunk UBA抽象了相关数据的不同，只提取了防火墙相关活动的数据，例如IP，端口，和防火墙动作行为信息。这种元数据以适当的视图进行标记，如**防火墙**，并且存储在数据体(一个数据体类似于一张excel表格)中。你也可以配置一般的数据源将原始数据直接传递到Splunk UBA中。这些原始数据属于一般的视图，并且也被存储在数据体中，也被用于异常处理过程。|
|4|异常模型|异常模型分析Splunk UBA中的数据(此时的数据格式一般为数据体)，并基于多种因素创建异常值 1、流式模型实时分析提取的数据，并确定这些数据在短时间内(如过去一小时)的影响。基于这种分析，流式模型可以在Splunk UBA中产生大量的项目，例如异常，失陷指标(IOCs),或分析数据 2、批处理模型和异常规则分析在较大的时间窗口(如过去24小时)内传入的数据，因为需要处理大量数据所以通常在夜晚运行。Splunk UBA中的所有威胁模型都是批处理模型，考虑到包括流处理命令编录数据与数据聚合。Splunk UBA有两种类型的批处理模型：(1)、罕见异常模型通过检测不寻常的，罕见的，首次活动来生成异常。(2)、时间序列模型通过跟踪一段时期之内的特定活动来产生异常。 你可以创建新的批处理异常模型，或者使用自定义的用例框架克隆存在的模型。请看[什么是自定义用例框架](http://docs.splunk.com/Documentation/UBA/5.0.4/Custom/CustomOverview)在*开发自定义内容*中。   异常被分组为各种类别，例如泄露，感染，扩大。这些类别通常对应于Kill Chain的各个阶段，使得威胁逻辑可以把异常放入Chain中正确部分。异常模型也向异常中添加元数据。这些元数据特定于单个异常类型，并用于在调查或异常捕获筛选异常。|
|5|异常|异常可以是数据中指的注意的地方，也可能是相对正常行为的偏离，或者是检测到的一些有趣的模式，例如beaconing。一个splunk UBA 操作者可以查看异常并且采取一切对应的措施。异常的范围和复杂性各不相同，从外部产品(如安全终端解决方案或防火墙)产生的有用警报的简单突出显示，到需要高级统计和机器学习模型来检测的隐秘的数据泄露尝试。异常由流模型、批处理模型和异常规则生成。您可以使用Splunk UBA中的异常操作规则来管理系统中现有的异常，作为异常创建流的一部分。例如，您可以删除或恢复异常，修改分数，或将异常添加到观察列表。您还可以自定义异常评分规则，以提供一定程度上的控制权和跨多个异常类型的一致性。异常既有types，也有categories. Types是异常的特定描述名称，而categories是异常的一般描述。多个异常Types可以共用一个categories，一个异常Types可以有多个categories。根据您希望规则或威胁的具体程度，使用异常Types或异常categories创建异常操作规则或自定义威胁。
|6|威胁模型和自定义威胁规则|Splunk UBA中的威胁模型根据系统中的数据和异常来构建动态威胁。您还可以创建自定义威胁规则来识别网络中可验证的威胁，比如您想要监控合规性的特定活动。对您的组织来说，创建、编辑、启用和管理自定义威胁是最有用的。您可以创建应用于用户、设备或会话的自定义威胁。Splunk UBA包含了几个自定义威胁。威胁模型考虑到Splunk UBA中的数据聚合，包括流模型编目的数据，以产生威胁。Splunk UBA中的所有威胁模型都以批处理模型的形式运行。威胁规则通过在特定的时间窗口内查找特定的异常模式来生成威胁。每次发现异常模式时都会产生一个威胁。每个规则都按照预先定义的时间表运行，这取决于规则的性质。
|7|威胁|威胁是一个或多个异常的集合，这些异常形成一个明确定义的安全定例，如数据泄露。威胁通常与IOC情报(IOC)有关并且与其他证据相关联，以提供一系列事件的详细描述。威胁可以通过以下方式计算:1、Kill Chain威胁检查特定用户或设备的所有异常情况，以确定与Kill Chain阶段相一致的模式。例如杀死链威胁是指可疑用户、设备的数据泄露和帐户的数据泄露。2、基于图的威胁是根据相似的异常组而不是根据用户或设备分组的异常来计算的。例如，基于图形的威胁是面向公众的网站攻击或欺诈网站活动。3、数据驱动的威胁收集关于异常和用户或设备的数据，以确定威胁的可能性。内部威胁通过数据驱动的计算过程进行计算。数据驱动威胁的例子是横向移动和数据撤离。4、当满足特定的一组条件时，将从自定义威胁规则引发基于规则的威胁。基于规则的威胁是暴力破解和数据暂存后的数据泄露。|
